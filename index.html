<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TITAN SST - GOLD EDITION</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@400;600;800&display=swap');

        :root {
            --neon: #00ff88;
            --blue: #00d4ff;
            --red: #ff3e3e;
            --bg: #0d0d0f;
            --card: #18181b;
            --border: #27272a;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header { background: #000; padding: 15px; border-bottom: 2px solid var(--neon); text-align: center; }
        header h1 { font-family: 'Orbitron'; font-size: 1.1rem; color: var(--neon); letter-spacing: 2px; }

        /* MENU DE NAVEGA√á√ÉO */
        nav { background: #000; display: flex; overflow-x: auto; border-bottom: 1px solid var(--border); }
        .nav-link { 
            padding: 15px; font-size: 0.65rem; font-weight: 800; color: #71717a; 
            text-transform: uppercase; cursor: pointer; flex: 1; text-align: center; min-width: 90px;
        }
        .nav-link.active { color: var(--neon); border-bottom: 3px solid var(--neon); background: rgba(0,255,136,0.05); }

        main { flex: 1; overflow-y: auto; padding: 12px; }

        /* SELE√á√ÉO DE CLIENTE */
        .selector-box { margin-bottom: 15px; }
        select { 
            width: 100%; background: #000; border: 2px solid var(--neon); color: var(--neon); 
            padding: 12px; border-radius: 10px; font-weight: bold; font-size: 0.9rem;
        }

        /* CARDS E WIDGETS */
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .widget { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        .widget label { font-size: 0.6rem; color: #a1a1aa; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .widget b { font-family: 'Orbitron'; font-size: 1.2rem; display: block; }

        /* TABELAS ORGANIZADAS */
        .table-container { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #000; color: #71717a; font-size: 0.6rem; text-transform: uppercase; padding: 10px; text-align: left; }
        td { padding: 12px 10px; border-bottom: 1px solid var(--border); font-size: 0.75rem; vertical-align: middle; }
        
        .row-off { opacity: 0.3; background: #000; }
        
        /* BOTOES E INPUTS */
        .btn-toggle { 
            width: 45px; padding: 5px; border-radius: 6px; border: none; font-weight: 800; font-size: 0.55rem; cursor: pointer;
        }
        .btn-sim { background: var(--neon); color: #000; }
        .btn-nao { background: #3f3f46; color: #fff; }

        .date-input-group { display: flex; gap: 3px; }
        .date-input-group input { 
            width: 32px; background: #000; border: 1px solid #3f3f46; color: #fff; 
            text-align: center; font-size: 0.7rem; padding: 5px 0; border-radius: 4px;
        }
        .date-input-group .ano { width: 48px; }

        .status-pill { padding: 3px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 800; }
        .st-ok { background: rgba(0,255,136,0.1); color: var(--neon); }
        .st-venc { background: rgba(255,62,62,0.1); color: var(--red); }

        .btn-titan { 
            background: var(--neon); color: #000; width: 100%; padding: 15px; border-radius: 10px; 
            border: none; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-top: 10px;
        }

        /* VISITAS */
        .visit-card { background: var(--card); padding: 15px; border-radius: 12px; border-left: 4px solid var(--neon); margin-bottom: 10px; }
        .visit-img { width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid var(--border); }

        .view-section { display: none; }
        .view-section.active { display: block; }
    </style>
</head>
<body>

<header><h1>TITAN SST GOLD</h1></header>

<nav>
    <div class="nav-link active" onclick="tab('dash')">Painel</div>
    <div class="nav-link" onclick="tab('docs')">Laudos</div>
    <div class="nav-link" onclick="tab('nrs')">Treinos</div>
    <div class="nav-link" onclick="tab('visit')">Visitas</div>
    <div class="nav-link" onclick="tab('cfg')">Gest√£o</div>
</nav>

<main>
    <div class="selector-box">
        <select id="selCli" onchange="changeCli()">
            <option value="">-- SELECIONE A UNIDADE --</option>
        </select>
    </div>

    <div id="v-dash" class="view-section active">
        <div class="widget" style="margin-bottom: 10px;">
            <label>Plano Contratado</label>
            <b id="d-plano" style="color: var(--blue);">--</b>
        </div>
        <div class="dash-grid">
            <div class="widget"><label>Conformidade</label><b id="d-perc">0%</b></div>
            <div class="widget"><label>Total Visitas</label><b id="d-vits" style="color: var(--yellow);">0</b></div>
        </div>
        <div id="d-alertas" style="background: rgba(255,62,62,0.1); padding: 10px; border-radius: 8px; border: 1px solid var(--red); display: none;">
            <label style="color: var(--red); font-weight: 800; font-size: 0.6rem;">PEND√äNCIAS:</label>
            <div id="d-lista-alerta" style="font-size: 0.7rem; margin-top: 5px;"></div>
        </div>
    </div>

    <div id="v-docs" class="view-section">
        <div class="table-container">
            <table>
                <thead><tr><th>Usa?</th><th>Documento</th><th>Data Base</th><th>Status</th></tr></thead>
                <tbody id="t-docs"></tbody>
            </table>
        </div>
        <button class="btn-titan" style="background: #fff;" onclick="pdf()">EXPORTAR PDF</button>
    </div>

    <div id="v-nrs" class="view-section">
        <div class="table-container">
            <table>
                <thead><tr><th>Usa?</th><th>Treinamento</th><th>Data Base</th><th>Status</th></tr></thead>
                <tbody id="t-nrs"></tbody>
            </table>
        </div>
    </div>

    <div id="v-visit" class="view-section">
        <div class="widget">
            <div class="date-input-group" style="margin-bottom: 10px;">
                <input type="number" id="vd" placeholder="DD">
                <input type="number" id="vm" placeholder="MM">
                <input type="number" id="vy" class="ano" placeholder="AAAA">
            </div>
            <textarea id="vtxt" placeholder="Relato da visita..." style="width:100%; height:80px; background:#000; color:#fff; border:1px solid var(--border); border-radius:8px; padding:10px;"></textarea>
            <input type="file" id="vfoto" accept="image/*" capture="environment" style="display:none" onchange="fots(this)">
            <button class="btn-titan" style="background:var(--blue);" onclick="document.getElementById('vfoto').click()">üì∏ TIRAR FOTO</button>
            <div id="vprev"></div>
            <button class="btn-titan" onclick="saveV()">SALVAR VISITA</button>
        </div>
        <div id="vlist" style="margin-top: 15px;"></div>
    </div>

    <div id="v-cfg" class="view-section">
        <div class="widget">
            <label>Novo Cliente</label>
            <input type="text" id="cnome" placeholder="Nome da Fazenda" style="width:100%; padding:10px; background:#000; border:1px solid var(--border); color:#fff; border-radius:8px; margin-bottom:10px;">
            <select id="cplano" style="border-color: var(--border); color: #fff; margin-bottom: 10px;">
                <option value="Basica">Assessoria B√°sica</option>
                <option value="Media">Assessoria M√©dia</option>
                <option value="Master">Assessoria Master</option>
            </select>
            <button class="btn-titan" onclick="addC()">CRIAR UNIDADE COMPLETA</button>
        </div>
        <div id="clist" style="margin-top: 15px;"></div>
    </div>
</main>

<script>
    let db = JSON.parse(localStorage.getItem('TITAN_DB_V23')) || {};
    let cur = ''; let fTemp = '';

    const L_PADRAO = ["PGR","PCMSO","LTCAT","PPP","AEP","LIP","LPP","PPR","PCA"];
    const T_PADRAO = ["NR-01","NR-05","NR-06","NR-10","NR-12","NR-23","NR-31.7","NR-31.12","NR-33","NR-35"];

    function tab(id) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById('v-'+id).classList.add('active');
        event.currentTarget.classList.add('active');
        if(id === 'cfg') rCfg();
    }

    function changeCli() { cur = document.getElementById('selCli').value; if(cur) render(); }

    function render() {
        const c = db[cur];
        document.getElementById('d-plano').innerText = c.plano;
        document.getElementById('d-vits').innerText = c.visitas.length;

        let ok = 0, tot = 0;
        const alerts = document.getElementById('d-lista-alerta'); alerts.innerHTML = '';

        const draw = (key, tid) => {
            const b = document.getElementById(tid); b.innerHTML = '';
            c[key].forEach((it, i) => {
                const isA = it.a !== false;
                const v = calcV(it);
                const st = !isA ? {t:'N/A', c:'st-na'} : (!v ? {t:'PEND', c:'st-venc'} : (v < new Date() ? {t:'VENC', c:'st-venc'} : {t:'OK', c:'st-ok'}));
                
                if(isA) { tot++; if(st.t === 'OK') ok++; if(st.t !== 'OK') alerts.innerHTML += `‚Ä¢ ${it.n} <br>`; }

                b.innerHTML += `<tr class="${isA ? '' : 'row-off'}">
                    <td><button class="btn-toggle ${isA ? 'btn-sim' : 'btn-nao'}" onclick="tog('${key}',${i})">${isA?'SIM':'N√ÉO'}</button></td>
                    <td><b>${it.n}</b></td>
                    <td><div class="date-input-group">
                        <input type="number" value="${it.d}" oninput="upd('${key}',${i},'d',this.value)">
                        <input type="number" value="${it.m}" oninput="upd('${key}',${i},'m',this.value)">
                        <input type="number" value="${it.y}" class="ano" oninput="upd('${key}',${i},'y',this.value)">
                    </div></td>
                    <td><span class="status-pill ${st.c}">${v && isA ? v.toLocaleDateString('pt-BR') : st.t}</span></td>
                </tr>`;
            });
        };

        draw('docs', 't-docs');
        draw('nrs', 't-nrs');

        document.getElementById('d-perc').innerText = tot ? Math.round((ok/tot)*100)+'%' : '0%';
        document.getElementById('d-alertas').style.display = alerts.innerHTML ? 'block' : 'none';

        const vl = document.getElementById('vlist'); vl.innerHTML = '';
        c.visitas.forEach(v => {
            vl.innerHTML += `<div class="visit-card">
                <small>${v.d}/${v.m}/${v.y}</small><p style="margin-top:5px; font-size:0.8rem;">${v.t}</p>
                ${v.f ? `<img src="${v.f}" class="visit-img">` : ''}
            </div>`;
        });
    }

    function calcV(it) { if(!it.y) return null; let d = new Date(it.y, it.m-1, it.d); d.setFullYear(d.getFullYear()+1); return d; }
    function tog(k, i) { db[cur][k][i].a = db[cur][k][i].a === false; save(); render(); }
    function upd(k, i, f, v) { db[cur][k][i][f] = v; save(); }
    function save() { localStorage.setItem('TITAN_DB_V23', JSON.stringify(db)); }
    
    function addC() {
        let n = document.getElementById('cnome').value;
        if(!n) return;
        db[n] = {
            plano: document.getElementById('cplano').value,
            docs: L_PADRAO.map(x => ({n:x, d:'', m:'', y:'', a:true})),
            nrs: T_PADRAO.map(x => ({n:x, d:'', m:'', y:'', a:true})),
            visitas: []
        };
        save(); location.reload();
    }

    function rCfg() {
        const l = document.getElementById('clist'); l.innerHTML = '';
        Object.keys(db).forEach(k => {
            l.innerHTML += `<div class="widget" style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span>${k}</span><button onclick="delC('${k}')" style="color:var(--red); border:none; background:none; font-weight:bold;">EXCLUIR</button>
            </div>`;
        });
    }
    function delC(k) { if(confirm('Apagar?')) { delete db[k]; save(); location.reload(); } }

    function fots(i) {
        const r = new FileReader();
        r.onload = e => { fTemp = e.target.result; document.getElementById('vprev').innerHTML = `<img src="${fTemp}" class="visit-img">`; };
        r.readAsDataURL(i.files[0]);
    }

    function saveV() {
        const d = document.getElementById('vd').value, m = document.getElementById('vm').value, y = document.getElementById('vy').value, t = document.getElementById('vtxt').value;
        if(!d || !t) return alert('Data e Relato obrigat√≥rios');
        db[cur].visitas.unshift({d, m, y, t, f: fTemp});
        fTemp = ''; document.getElementById('vprev').innerHTML = ''; document.getElementById('vtxt').value = '';
        save(); render();
    }

    function pdf() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.text(`SST TITAN - ${cur}`, 14, 20);
        let data = db[cur].docs.filter(x => x.a !== false).map(x => [x.n, `${x.d}/${x.m}/${x.y}`, calcV(x)?calcV(x).toLocaleDateString():'PEND']);
        doc.autoTable({ head: [['Item','Base','Vencimento']], body: data, startY: 30 });
        doc.save(`TITAN_${cur}.pdf`);
    }

    // Init Select
    Object.keys(db).sort().forEach(k => {
        let o = document.createElement('option'); o.value = k; o.innerText = k; document.getElementById('selCli').appendChild(o);
    });
</script>
</body>
</html>
